# ==============================================================================
# § 通用跨域网关（开发环境强化版）
# ==============================================================================
#
# [ 解决什么问题？]
# 当你在本地（如 http://localhost:8080）开发前端项目时，浏览器出于安全考虑，
# 会禁止你的代码直接请求另一个域名（如 https://api.github.com）的接口。
# 这就是所谓的“跨域问题”（CORS）。
#
# 本网关作为一个中间代理，帮你绕过这个限制。你的前端代码只需请求本网关，
# 网关会代替浏览器去请求目标 API，然后将结果返回给你的前端页面。
#
# [ 如何使用？]
# 假设网关地址是 http://127.0.0.1:7888，需要请求的目标 API 是 https://api.github.com/users/octocat
#
# const target = 'https/api.github.com/users/octocat'; // 注意：协议和域名之间没有冒号和斜杠
# const gateway = 'http://127.0.0.1:7888';
# fetch(`${gateway}/proxy/${target}`);
#

# ------------------------------------------------------------------------------
# § 0. (可选) 上游代理设置
# ------------------------------------------------------------------------------
# “上游代理”通常指部署在本 Nginx 前面的另一层代理，比如云服务商的负载均衡器（LB）。
# 如果你的 Nginx 是这样部署的，用户的真实 IP 会丢失。取消下面的注释可以帮助 Nginx 找回真实 IP。
#
# set_real_ip_from  192.168.1.1; # 填写上游代理的 IP 地址
# real_ip_header    X-Forwarded-For;
# real_ip_recursive on;

# ------------------------------------------------------------------------------
# § 1. 安全防线一：IP 白名单
# ------------------------------------------------------------------------------
# 只有这里列出的 IP 地址，才有资格访问本网关。这可以有效防止公网上的陌生设备访问。
# 默认已包含本机和常见的内网地址段，通常无需修改。
geo $is_whitelisted {
    default 0;
    127.0.0.1        1; # 允许本机访问
    192.168.0.0/16   1; # 允许 192.168.x.x 的局域网设备访问
    10.0.0.0/8       1; # 允许 10.x.x.x 的局域网设备访问
    172.16.0.0/12    1; # 允许 Docker/虚拟网络访问
    # 如有 IPv6 内网段，可在此补充，例如：'::1 1;'
}

# ------------------------------------------------------------------------------
# § 2. 安全防线二：请求来源（Origin）白名单
# ------------------------------------------------------------------------------
# “Origin”指发起请求的前端页面所在的地址（如 http://localhost:8080）。
# 只有在这里列出的页面，才有权使用本代理。这可以防止其他恶意网站利用你的代理。
#
# ✅ [请按需修改] 将你前端项目的访问地址加到下面。
map $http_origin $cors_origin_allowed {
    default ""; # 默认禁止所有未列出的 Origin

    # 允许本机开发环境（localhost 或 127.0.0.1，任意端口）
    "~^https?://localhost(:\d+)?$"      $http_origin;
    "~^https?://127\.0\.0\.1(:\d+)?$"   $http_origin;

    # 允许局域网内的其他设备访问你的前端项目（例如手机调试）
    "~^https?://192\.168\.\d+\.\d+(:\d+)?$" $http_origin;

    # 示例：允许特定的线上域名
    # "~^https://dev\.example\.com$" $http_origin;
}

# 辅助变量，用于后续判断 Origin 是否在白名单内
map $cors_origin_allowed $is_cors_ok {
    default 0; # 不允许
    ""      0; # 不允许
    ~.+     1; # 允许 (只要 $cors_origin_allowed 不是空字符串)
}

# ------------------------------------------------------------------------------
# § 3. 安全防线三：目标域名白名单
# ------------------------------------------------------------------------------
# 它规定了本代理 *允许* 转发请求到哪些目标服务器。
# 这可以防止"服务器端请求伪造"（SSRF）攻击，即攻击者利用你的代理去扫描或攻击你的内网。
#
# ✅ [请按需修改] 把你开发中需要用到的 API 域名加到下面。
map $target_host $is_target_allowed {
    default 0; # 默认禁止所有未列出的域名

    # 示例域名
    "api.github.com"             1;
    "jsonplaceholder.typicode.com" 1;

    # 临时示例：允许任意域名（⚠️ 生产环境请移除此行，存在安全风险）
    "~^[A-Za-z0-9\.\-]+$"        1;

    # 示例：允许所有 *.google.com 的子域名 (注意：通配符存在安全风险，请谨慎使用)
    # "~^(.+\.)?google\.com$"    1;
}

# ------------------------------------------------------------------------------
# § 4. 安全防线四：HTTP 请求方法限制
# ------------------------------------------------------------------------------
# 为了安全，默认只允许“读取”数据的请求（GET）。
#
# ✅ [请按需修改] 如果你需要测试“写入”数据的操作（如 POST、PUT），请将对应行的 0 改为 1。
map $request_method $is_method_allowed {
    default 0;
    GET     1; # 获取数据
    HEAD    1; # 获取元信息
    OPTIONS 1; # CORS 预检请求，必须允许

    POST    0; # 创建数据
    PUT     0; # 更新数据
    DELETE  0; # 删除数据
}

# ------------------------------------------------------------------------------
# § 5. 保护机制：速率限制
# ------------------------------------------------------------------------------
# 限制单个 IP 的请求频率（这里是每秒 50 次），防止因代码错误（如死循环）或恶意攻击拖垮服务。
limit_req_zone $binary_remote_addr zone=gateway_lan:10m rate=50r/s;

# ------------------------------------------------------------------------------
# § 6. 日志格式定义
# ------------------------------------------------------------------------------
# 在标准日志基础上，额外记录了 `origin`（请求来源）和 `target`（代理目标），方便排查问题。
log_format gateway_fmt '$remote_addr - [$time_local] "$request" '
                       'status=$status origin="$http_origin" '
                       'target="$target_host" rt=$request_time';

# ==============================================================================
# § 服务器主体配置
# ==============================================================================
server {
    listen 7888;
    server_name _; # 接受所有指向此端口的域名请求

    access_log /var/log/nginx/gateway_access.log gateway_fmt;
    error_log  /var/log/nginx/gateway_error.log warn;

    # --- 第一步：IP 准入检查 ---
    # 如果请求的 IP 不在白名单 (§1) 中，直接拒绝。
    if ($is_whitelisted = 0) {
        return 403; # 403 Forbidden
    }

    # --- 健康检查页面 ---
    # 方便你确认网关是否在运行。浏览器访问 http://127.0.0.1:7888/ 即可。
    location = / {
        add_header Content-Type "text/plain; charset=utf-8";
        return 200 "Gateway Online\nYour IP: $remote_addr\n";
    }

    # 忽略浏览器自动发起的 /favicon.ico 请求，避免产生不必要的日志。
    location = /favicon.ico { return 204; }

    # ------------------------------------------------------------------------------
    # § 7. 核心代理逻辑
    # ------------------------------------------------------------------------------
    # 匹配形如 /proxy/https/api.github.com/users/octocat 这样的 URL
    location ~* ^/proxy/(https?)/([A-Za-z0-9\.\-]+)(.*)$ {
        # 启用速率限制 (§5)
        limit_req zone=gateway_lan burst=100 nodelay;

        # (1) 从 URL 中提取参数
        set $proxy_scheme $1; # $1 是 (https?) -> "http" 或 "https"
        set $target_host  $2; # $2 是 ([A-Za-z0-9\.\-]+) -> "api.github.com"
        set $target_uri   $3; # $3 是 (.*) -> "/users/octocat"

        # (2) 执行安全检查
        # 检查请求方法是否在白名单 (§4) 中
        if ($is_method_allowed = 0) {
            return 405; # 405 Method Not Allowed
        }
        # 检查请求来源 Origin 是否在白名单 (§2) 中
        if ($is_cors_ok = 0) {
            return 403; # 403 Forbidden (Invalid Origin)
        }
        # 检查目标域名是否在白名单 (§3) 中
        if ($is_target_allowed = 0) {
            return 403; # 403 Forbidden (SSRF Protection)
        }

        # (3) 配置 DNS 解析
        # Nginx 需要用 DNS 查询目标域名的 IP 地址。默认使用公共 DNS。
        # ⚠️ 如果需要代理内网域名，请换成你的内网 DNS 服务器地址。
        resolver 8.8.8.8 1.1.1.1 valid=300s;
        resolver_timeout 5s;

        # (4) 配置 TLS SNI (代理 HTTPS 网站的关键)
        # 它会在建立加密连接时，告诉目标服务器我们想访问哪个域名。
        proxy_ssl_server_name on;
        proxy_ssl_name        $target_host;

        # ==================================================
        # § CORS 核心处理
        # ==================================================
        # 浏览器在发送某些复杂请求前，会先发一个 OPTIONS 方法的“预检请求”，
        # 询问服务器是否允许跨域。这里我们对预检和正常请求分别处理。

        # --- 处理预检请求 (Preflight / OPTIONS) ---
        if ($request_method = OPTIONS) {
            # 返回允许跨域的各种头部信息，告诉浏览器：“我允许你跨域”。
            add_header 'Access-Control-Allow-Origin'  $cors_origin_allowed always;
            add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since' always;
            add_header 'Access-Control-Max-Age'       1728000 always; # 预检结果的缓存时间
            add_header 'Content-Type'                 'text/plain; charset=utf-8';
            add_header 'Content-Length'               0;
            return 204; # 204 No Content，表示预检成功
        }

        # --- 处理正常请求 (Actual Request) ---
        # 对于非预检的正常请求，同样需要返回允许跨域的头部信息。
        add_header 'Access-Control-Allow-Origin'      $cors_origin_allowed always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods'     'GET, HEAD, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers'     'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since' always;
        add_header 'Vary'                             'Origin' always; # 告诉下游缓存，响应内容根据 Origin 的不同而不同

        # ==================================================
        # § 代理转发配置
        # ==================================================
        # 将请求转发给目标服务器
        proxy_pass $proxy_scheme://$target_host$target_uri$is_args$args;

        # 代理连接优化
        proxy_http_version 1.1; # 使用 HTTP/1.1
        proxy_set_header Connection ""; # 清除 Connection 头，改用 Nginx 管理长连接

        # 透传客户端信息
        proxy_set_header Host              $target_host; # 将 Host 头设置为目标域名
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 移除目标服务器可能返回的 CORS 头，由本网关统一控制，防止冲突。
        proxy_hide_header 'Access-Control-Allow-Origin';
        proxy_hide_header 'Access-Control-Allow-Credentials';

        # 其它超时等设置
        proxy_redirect          off;
        proxy_connect_timeout   10s;
        proxy_read_timeout      60s;
    }

    # --- 兜底规则 ---
    # 如果请求的 URL 不匹配任何前面的规则，则返回 404。
    location / { return 404; }
}
