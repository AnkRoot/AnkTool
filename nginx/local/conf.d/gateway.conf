# ===================================================================
# 遗产架构师: 通用跨域网关
# 原则: 单一事实来源, 纵深防御, 无损透明
# ===================================================================

# --- 模块零: 单一事实来源 (Single Source of Truth) ---
geo $is_whitelisted {
    default 0; # 默认：拒绝 (不在白名单)

    # --- 白名单 ---
    127.0.0.1      1; # 允许服务器本机
    192.168.31.0/24 1; # 允许本地开发网络
    # 10.20.0.0/16   1; # 示例: 允许一个办公网络
}

server {
    listen 8080;
    server_name _; # 监听所有主机名

    # --- 模块一: 网络准入控制 (Network Access Control) ---
    # 这是第一道防线。如果IP不在白名单($is_whitelisted为0)，则立即拒绝。
    # 这个检查对所有location都生效。
    if ($is_whitelisted = 0) {
        return 403;
    }

    # --- 模块二: 核心代理引擎 ---
    location ~* ^/proxy/(https?)/([^/]+)(.*)$ {
        set $proxy_scheme $1;
        set $target_host  $2;
        set $target_uri   $3;

        # --- 动态解析 ---
        resolver 8.8.8.8 1.1.1.1 valid=300s; # 使用公共DNS，设置缓存时间
        resolver_timeout 5s;
        
        proxy_pass $proxy_scheme://$target_host$target_uri$is_args$args;

        # --- CORS协议强制执行 ---
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;
        add_header 'Access-Control-Max-Age' 1728000 always;

        # --- 预检请求拦截: 提高效率，减少后端负载 ---
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # --- 协议转换器 (信息保真) ---
        proxy_set_header Host $target_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_scheme;
        proxy_set_header Accept-Encoding ""; # 防止后端压缩导致乱码

        # 隐藏从后端可能传回的CORS头，由网关统一控制
        proxy_hide_header 'Access-Control-Allow-Origin';
        proxy_hide_header 'Access-Control-Allow-Credentials';

        # --- 健壮性配置 ---
        proxy_connect_timeout 10s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        proxy_redirect default;
    }

    # --- 模块三: 状态与诊断端点 ---
    location / {
        return 200 "Legacy Architect's Universal CORS Gateway v4.0 - Operational.\nAccess granted for your IP ($remote_addr).\n";
        add_header Content-Type text/plain;
    }
}



# 前提条件:
# 1. 运行此代码的机器IP必须在Nginx的allow列表中。
# 2. 如果不在列表中，请求将被Nginx在TCP层直接拒绝或返回403，
#    甚至不会进入CORS处理阶段。
# const targetUrl = 'https/api.github.com/users/octocat';
# const gatewayServer = 'http://192.168.31.234:8080'; // 假设这是Nginx监听的地址
# fetch(`${gatewayServer}/proxy/${targetUrl}`, {})