# ===================================================================
# 通用反向代理网关 v6.0 (Hardened + CORS Ready)
# 作用域: http {}
# ===================================================================

# ------------------------------
# 0. 访问白名单 (HTTP 级)
# ------------------------------
geo $is_whitelisted {
    default        0;
    127.0.0.1      1;
    ::1            1;
    10.0.0.0/8     1;
    172.16.0.0/12  1;
    192.168.0.0/16 1;
}

# ------------------------------
# 1. WebSocket 连接头管理 (HTTP 级)
# ------------------------------
map $http_upgrade $connection_upgrade {
    default          close;
    ""               close;
    "websocket"      upgrade;
}

# ------------------------------
# 2. CORS Origin 白名单 (HTTP 级)
#    - 默认不返回 CORS 头
#    - 常见前端开发场景: localhost / 127.0.0.1 / 内网
# ------------------------------
map $http_origin $cors_origin {
    default "";
    ~^https?://(localhost(:\d+)?|127\.0\.0\.1(:\d+)?|192\.168\.\d+\.\d+(:\d+)?|10\.\d+\.\d+\.\d+(:\d+)?|172\.(1[6-9]|2[0-9]|3[0-1])\.\d+\.\d+(:\d+)?) $http_origin;
}


# ===================================================================
# 3. 通用网关 Server (作用域: server {})
# ===================================================================

server {
    listen 7889 default_server;
    server_name _;

    # --------------------------
    # 3.1 访问控制 (IP 白名单)
    # --------------------------
    if ($is_whitelisted = 0) {
        return 403 "Legacy Gateway: Access Denied.";
    }

    # --------------------------
    # 3.2 基础安全 / 限制
    # --------------------------
    client_max_body_size 32m;

    # 基本超时（开发环境可以适当放大）
    proxy_connect_timeout 5s;
    proxy_send_timeout    60s;
    proxy_read_timeout    60s;
    send_timeout          60s;

    # --------------------------
    # 3.3 预处理: 尾部斜杠修正
    #   /proxy/https/example.com  => 302 /proxy/https/example.com/
    # --------------------------
    location ~* ^/proxy/https?/[^/]+$ {
        return 302 $uri/;
    }

    # --------------------------
    # 3.4 核心通用代理引擎
    #      /proxy/(http|https)/host/anything...
    # --------------------------
    location ~* ^/proxy/(https?)/([^/]+)(.*)$ {
        # 1. 捕获变量
        set $proxy_scheme $1;
        set $target_host  $2;
        set $target_uri   $3;
        set $proxy_prefix "/proxy/$proxy_scheme/$target_host";

        # 2. CORS 预检处理 (OPTIONS)
        if ($request_method = OPTIONS) {
            # 仅当有匹配的白名单 Origin 时返回 CORS 头
            if ($cors_origin != "") {
                add_header Access-Control-Allow-Origin      $cors_origin always;
                add_header Access-Control-Allow-Credentials "true"       always;
                add_header Access-Control-Allow-Methods     "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
                add_header Access-Control-Allow-Headers     $http_access_control_request_headers always;
                add_header Access-Control-Max-Age           86400 always;
            }
            return 204;
        }

        # 3. DNS 解析（可换成内部 DNS）
        resolver 8.8.8.8 1.1.1.1 valid=300s ipv6=off;
        resolver_timeout 5s;

        # 4. SSL/TLS 握手（Dev 环境默认信任后端）
        proxy_ssl_server_name on;
        proxy_ssl_name        $target_host;
        proxy_ssl_verify      off;
        proxy_ssl_protocols   TLSv1.2 TLSv1.3;

        # 5. 代理请求发送
        proxy_pass $proxy_scheme://$target_host$target_uri$is_args$args;

        # 6. 请求头伪装 / 保留
        proxy_http_version 1.1;
        proxy_set_header Host            $target_host;
        proxy_set_header Referer         "$proxy_scheme://$target_host$target_uri";
        proxy_set_header Origin          "$proxy_scheme://$target_host";
        proxy_set_header X-Real-IP       $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # WebSocket / Keep-alive 支持
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # 禁用后端压缩，确保 sub_filter 可用
        proxy_set_header Accept-Encoding "";

        # 7. CORS 响应头（实际业务请求）
        if ($cors_origin != "") {
            add_header Access-Control-Allow-Origin      $cors_origin always;
            add_header Access-Control-Allow-Credentials "true"       always;
            # 暴露常见头，避免前端受限
            add_header Access-Control-Expose-Headers    "Content-Length,Content-Type,Date,Server,Content-Encoding" always;
        }

        # 8. 重定向修正
        proxy_redirect $proxy_scheme://$target_host/ $proxy_prefix/;
        proxy_redirect / $proxy_prefix/;

        # 9. Cookie Path 修正
        proxy_cookie_path / "$proxy_prefix/";

        # 10. 响应体内容重写 (路径 & SRI)
        sub_filter_types
            text/html
            text/css
            text/xml
            application/javascript
            application/json
            image/svg+xml;

        sub_filter_once off;

        # HTML 里的绝对路径
        sub_filter 'href="/'   'href="$proxy_prefix/';
        sub_filter "href='/"   "href='$proxy_prefix/";
        sub_filter 'src="/'    'src="$proxy_prefix/';
        sub_filter "src='/"    "src='$proxy_prefix/";
        sub_filter 'action="/' 'action="$proxy_prefix/';
        sub_filter "action='/" "action='$proxy_prefix/";

        # CSS url()
        sub_filter 'url("/' 'url("$proxy_prefix/';
        sub_filter "url('/" "url('$proxy_prefix/";
        sub_filter 'url(/'  'url($proxy_prefix/';

        # srcset 简单处理
        sub_filter 'srcset="/' 'srcset="$proxy_prefix/';

        # 移除 SRI，避免哈希校验失败
        sub_filter 'integrity="' 'data-integrity-disabled="';
        sub_filter "integrity='" "data-integrity-disabled='";

        # 防止绝对 URL 跳出代理（注意: 可能修改文本中出现的完整 URL）
        sub_filter "$proxy_scheme://$target_host/" "$proxy_prefix/";

        # 11. 缓冲区调整（防止大响应 + 重写截断）
        proxy_buffers         16 32k;
        proxy_buffer_size     64k;
        proxy_busy_buffers_size 128k;
    }

    # --------------------------
    # 3.5 网关状态页
    # --------------------------
    location = / {
        default_type text/html;
        return 200 "<h1>Universal Gateway v6.0</h1>\
<p>Status: <span style='color:green'>Operational</span></p>\
<p>Usage: /proxy/https/www.example.com/</p>";
    }
}
