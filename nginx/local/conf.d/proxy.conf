# ===================================================================
# 遗产架构师: 通用反向代理网关 v5.0 (含路径重写)
# 原则: 动态重写, 全方位欺骗 (响应体、头、Cookie)
# 警告: 此方案对JS动态内容无效，且性能开销大
# ===================================================================

server {
    listen 7899;
    server_name _; # 监听所有主机名

    # --- 模块零/一: 访问控制 (保持) ---
    geo $is_whitelisted {
        default 0;
        127.0.0.1      1;
        192.168.31.0/24 1;
    }
    if ($is_whitelisted = 0) {
        return 403;
    }

    # --- 模块二: 核心通用代理引擎 (完全重构) ---
    location ~* ^/proxy/(https?)/([^/]+)(.*)$ {
        # --- 1. 捕获和设置变量 ---
        set $proxy_scheme $1;
        set $target_host  $2;
        set $target_uri   $3;
        # 构建代理前缀，用于后续重写。非常重要！
        set $proxy_prefix "/proxy/$proxy_scheme/$target_host";

        # --- 2. 动态解析 (保持) ---
        resolver 8.8.8.8 1.1.1.1 valid=300s;
        resolver_timeout 5s;
        
        # --- 3. 核心代理 (proxy_pass) ---
        proxy_pass $proxy_scheme://$target_host$target_uri$is_args$args;

        # --- 4. 协议转换器 ---
        proxy_set_header Host $target_host;
        proxy_set_header Referer "$proxy_scheme://$target_host"; # 伪造Referer
        proxy_set_header Origin "$proxy_scheme://$target_host"; # 伪造Origin
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $proxy_scheme;
        # 必须禁用压缩，否则sub_filter和proxy_cookie_path无法工作
        proxy_set_header Accept-Encoding "";

        # --- 5. [核心] 全方位路径重写 ---
        
        # 5.1: 重写响应头中的 Location (用于301/302重定向)
        # 将 Location: /some/path 重写为 Location: /proxy/https/host/some/path
        # 注意: proxy_redirect指令会在内部处理更复杂的 Location，如 "https://other.com/"
        proxy_redirect ~^($proxy_scheme://[^/]+)?/$ $proxy_prefix/;

        # 5.2: 重写响应头中的 Cookie Path
        # 将 Set-Cookie: ... path=/ ... 重写为 path=/proxy/https/host/
        proxy_cookie_path / "$proxy_prefix/";

        # 5.3: 重写响应体 (HTML/CSS/JS)
        # 这是最脆弱但必要的部分。
        # 将 href="/path" 替换为 href="/proxy/scheme/host/path"
        sub_filter_types text/html text/css text/javascript application/javascript application/json;
        sub_filter_once off; # 需要全局替换，不能只换一次
        sub_filter 'href="/'  'href="$proxy_prefix/';
        sub_filter "href='/"  "href='$proxy_prefix/";
        sub_filter 'src="/'   'src="$proxy_prefix/';
        sub_filter "src='/"   "src='$proxy_prefix/";
        sub_filter 'action="/' 'action="$proxy_prefix/';
        sub_filter "action='/" "action='$proxy_prefix/";
        sub_filter 'url(/' 'url($proxy_prefix/';
        # 替换目标网站的绝对URL，防止跨域或跳出代理
        sub_filter "$proxy_scheme://$target_host/" "$proxy_prefix/";

        # --- 6. 健壮性配置 (保持) ---
        proxy_connect_timeout 10s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
    }

    # --- 模块三: 状态与诊断端点 ---
    location / {
        return 200 "Legacy Architect's Universal Reverse Proxy Gateway v5.0 - Operational.\n";
        add_header Content-Type text/plain;
    }
}