# =======================================================
# 项目 "Ank" 的变量定义
#  onboarding一个新项目时，你只需要复制并修改此文件
# =======================================================

# 使用 map 指令，这是定义变量的最安全、最高效的方式
# 它只在变量被实际使用时才进行计算

# --- 项目核心变量 ---
map $host $project_ank_frontend_port {
    default "5173"; # 你的前端开发服务器端口
}
map $host $project_ank_backend_port {
    default "443"; # 你的后端开发服务器端口
}

# --- 本地域名变量 ---
map $host $project_ank_frontend_domain {
    default "ank.local";
}
map $host $project_ank_backend_domain {
    default "api.ank.local";
}

# --- 线上环境域名 ---
map $host $project_ank_online_domain {
    default "work.online-domain.com"; # 你的线上域名
}


# =======================================================
# 项目 "Ank" 的核心本地开发代理规则
# =======================================================

# --- 场景 A.1: ank.local -> localhost:5173 ---
# 永久开启：访问 https://ank.local = 本机前端开发服务器。
server {
    listen 80;
    server_name $project_ank_frontend_domain;
    # --- SSL/TLS for Local Dev (Merged from ssl_local_dev.conf) ---
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    ssl_certificate /etc/nginx/ssl/local/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/local/key.pem;

    location / {
        proxy_pass http://127.0.0.1:$project_ank_frontend_port;
        include snippets/proxy-common.conf;
        include snippets/proxy-ws.conf; # 用于 HMR
    }
}

# --- 场景 A.2: api.ank.local -> localhost:3000 ---
# 永久开启：访问 https://api.ank.local = 本机后端接口。
server {
    listen 80;
    server_name $project_ank_backend_domain;
    # --- SSL/TLS for Local Dev (Merged from ssl_local_dev.conf) ---
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    ssl_certificate /etc/nginx/ssl/local/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/local/key.pem;

    location / {
        proxy_pass http://127.0.0.1:$project_ank_backend_port;
        include snippets/proxy-common.conf;
        include snippets/proxy-ws.conf;
    }
}


# =======================================================
# 场景 B（默认注释）
# 功能：访问 https://work.online-domain.com 时命中本地前端。
# 启用：去掉整段 `#`，reload。关闭：重新加 `#`。与场景 C 互斥。
# =======================================================
# server {
#     listen 80;
#     server_name $project_ank_online_domain; # 从变量文件中读取线上域名
#     # --- SSL/TLS for Local Dev (Merged from ssl_local_dev.conf) ---
#     listen 443 ssl;
#     listen [::]:443 ssl;
#     http2 on;
#     ssl_certificate /etc/nginx/ssl/local/cert.pem;
#     ssl_certificate_key /etc/nginx/ssl/local/key.pem;

#     # 所有流量都导向本地前端开发服务器
#     location / {
#         proxy_pass http://127.0.0.1:$project_ank_frontend_port;
#         include snippets/proxy-common.conf;
#         include snippets/proxy-ws.conf;
#     }
# }


# =======================================================
# 场景 C（默认注释）
# 功能：`/api/` 走本地后端，其它路径仍访问线上域名。
# 启用/关闭方式同场景 B，且二选一。
# =======================================================
# server {
#     listen 80;
#     server_name $project_ank_online_domain;
#     # --- SSL/TLS for Local Dev (Merged from ssl_local_dev.conf) ---
#     listen 443 ssl;
#     listen [::]:443 ssl;
#     http2 on;
#     ssl_certificate /etc/nginx/ssl/local/cert.pem;
#     ssl_certificate_key /etc/nginx/ssl/local/key.pem;

#     # 规则1: 拦截API流量到本地
#     location /api/ {
#         proxy_pass http://127.0.0.1:$project_ank_backend_port;
#         include snippets/proxy-common.conf;
#         include snippets/proxy-ws.conf;
#     }

#     # 规则2: 其他所有流量代理回线上真实服务器
#     location / {
#         proxy_pass https://$project_ank_online_domain;
#         include snippets/proxy-common.conf;
#         # 必须手动重写Host头，以匹配上游服务器
#         proxy_set_header Host $project_ank_online_domain;
#     }
# }
