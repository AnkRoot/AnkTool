# /etc/nginx/snippets/fastcgi-php.conf
# ----------------------------------------------------------------------
# 架构性 PHP-FPM 连接器 V2.0
# 核心原则:
# 1. 继承标准: 建立在官方 fastcgi_params 的基础上，确保兼容性。
# 2. 上下文无关: 不包含任何特定于 server 块的指令。
# 3. 健壮性: 增加错误捕获和安全增强。
# ----------------------------------------------------------------------

# 继承 Nginx 官方提供的标准 FastCGI 参数集。
# 这是最佳实践，确保所有基础 CGI 变量都已正确设置。
include fastcgi_params;

# --- 增强与优化 ---

# 捕获PHP后端的错误，以便Nginx可以使用 error_page 指令处理它们。
# 如果没有此项，PHP的500错误将直接展示给用户，而不是你定义的漂亮错误页面。
fastcgi_intercept_errors on;

# 将请求分割到 index.php 和路径信息，用于支持 /index.php/foo/bar 这样的路由。
fastcgi_split_path_info ^(.+\.php)(/.+)$;

# 当传递的脚本文件不存在时，立即返回404。
# 这是防止将无效请求传递给PHP-FPM的关键安全措施。
try_files $fastcgi_script_name =404;

# 告诉后端应用，原始请求是 HTTPS 的。
# 许多框架（如Laravel, Symfony）依赖此变量来生成安全的URL。
# 注意: 我们不再硬编码 'on'，而是从主配置中传递变量，使其更具弹性。
fastcgi_param HTTPS $fastcgi_https;

# [REMOVED] fastcgi_param SCRIPT_FILENAME ...
# 致命的冗余已被移除。此参数的定义是 server 块的责任，
# 因为它需要动态的 $document_root 变量，而这个 snippet 不应该知道它的存在。