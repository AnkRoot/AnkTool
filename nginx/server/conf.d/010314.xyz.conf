# 站点: 010314.xyz (动态路由架构 V5.0 - 零信任)

# ======================================================================
# 第一部分: 路由映射表 (The Constitution)
# ======================================================================

# --- 映射1: 主机 -> 站点根目录 (静态默认入口)
map $host $site_root {
    # 默认规则: 自动将子域名映射到同名目录。
    # 例如: blog.010314.xyz -> /var/www/010314.xyz/blog
    ~*^(?<subdomain>.+)\.010314\.xyz\.?$   /var/www/010314.xyz/$subdomain;
    
    # 精确匹配: 为根域名指定目录。
    ~*^010314\.xyz\.?$                     /var/www/010314.xyz/main;
    # 示例: files.010314.xyz    /srv/data/files;
}

# --- 映射2: 主机 -> 后端地址 (全站反代入口)
map $host $backend_target {
    hostnames;
    # 示例: api.010314.xyz    127.0.0.1:8080;
    default             "";
}

# --- 映射3: sites-overrides 守卫变量
map $host $work_override_guard {
    hostnames;
    work.010314.xyz   1;
    default           0;
}

# --- 映射4: 主机 -> 是否启用 PHP
map $host $is_php_site {
    hostnames;
    # 示例: blog.010314.xyz   1;
    default             0; # 默认禁用PHP
}

# --- 映射5: PHP 开关 -> 回退资源
map $is_php_site $fallback_file {
    1   /index.php?$query_string; # PHP站点的回退路径
    0   /index.html;              # 静态/SPA站点的回退路径
}

# ======================================================================
# 第二部分: 单一服务入口 (The Engine)
# ======================================================================

server {
    # 监听443端口，并启用SSL和HTTP/2。
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # 使用前导点匹配根域名和所有子域名，作为统一入口。
    server_name .010314.xyz;

    # --- 身份与加密核心 ---
    # 1. 指定服务器身份 (由Cloudflare签发的源站证书)。
    ssl_certificate /etc/ssl/certs/cloudflare_origin.pem;
    ssl_certificate_key /etc/ssl/private/cloudflare_origin.key;

    # 2. 强制验证客户端身份 (必须是Cloudflare)。
    include snippets/cloudflare-mtls-auth.conf;

    # 3. 安全的真实IP获取。
    real_ip_header CF-Connecting-IP;
    # set_real_ip_from 0.0.0.0/0;
    # set_real_ip_from ::/0;
    # IP列表来自 https://www.cloudflare.com/ips/ (2025-12-01)。
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;
    real_ip_recursive on;

    # --- 通用代理配置注入点 ---
    include snippets/proxy-common.conf;
    # --- 通用配置 ---
    include snippets/security-headers.conf;
    # 日志汇聚至固定文件，具体主机由log_format中的$host字段记录。
    access_log /var/log/nginx/010314.xyz.access.log main_ext;
    error_log /var/log/nginx/010314.xyz.error.log;
    # 根目录由上方的map指令动态决定。
    root $site_root;

    # 为特殊站点提供覆盖配置的扩展插槽（逐条显式 include，杜绝通配符失控）。
    include /etc/nginx/sites-overrides/work.010314.xyz.conf;

    # --- 核心路由逻辑 ---
    location / {
        # 仅当$backend_target非空时，才执行反向代理。
        if ($backend_target != "") {
            proxy_pass http://$backend_target;
            break; 
        }
    
        # 如果不是反向代理请求，则作为静态或PHP站点处理。
        index index.html index.htm index.php;
        try_files $uri $uri/ $fallback_file;
    }

    # --- PHP处理逻辑 ---
    location ~ \.php$ {
        # 如果站点未在map中标记为PHP站点，则拒绝访问.php文件。
        if ($is_php_site = 0) {
            return 404;
        }
        include snippets/fastcgi-php.conf;
        
        # 核心职责：告知 PHP-FPM 要执行哪个具体的脚本文件。
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        
        # 连接到 PHP-FPM 服务。
        fastcgi_pass unix:/run/php/php8.1-fpm.sock; 
    }

    # --- 通用静态资源与安全规则 ---
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # --- 通用安全规则 ---
    location ~ /\. {
        deny all; # 拒绝访问.htaccess, .git等隐藏文件。
    }
}

# --- HTTP到HTTPS的全局重定向规则 ---
server {
    listen 80;
    listen [::]:80;
    server_name .010314.xyz;
    
    location / {
        return 301 https://$host$request_uri;
    }
}
