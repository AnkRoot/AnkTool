# /etc/nginx/nginx.conf
# 零信任架构 V5.0 - 全局配置

# 定义Nginx工作进程的用户。建议使用一个非特权用户，例如 www-data 或 nginx。
# 如果你的PHP-FPM或其他服务使用特定用户，保持一致性可能更好。
user ank; 
# 根据CPU核心数自动优化工作进程数量。
worker_processes auto;

# Nginx主进程的PID文件路径。
pid /run/nginx.pid;

# 动态加载模块。
include /etc/nginx/modules.d/*.conf;
include /etc/nginx/modules-enabled/*.conf;

events {
    # 每个工作进程允许的最大并发连接数。
    worker_connections 2048;
    # 优化网络连接处理，允许一次性接受所有新连接，在高并发下提升性能。
    multi_accept on;
}

http {
    # --- 基础网络与性能优化 ---
    sendfile on;                 # 开启高效文件传输模式，减少内核态到用户态的拷贝。
    tcp_nopush on;               # 在sendfile开启时，将多个小包组合成一个大包发送，提高网络效率。
    tcp_nodelay on;              # 禁用Nagle算法，降低小数据包的延迟，对API和WebSocket友好。
    keepalive_timeout 65s;       # HTTP长连接的超时时间，平衡资源占用和性能。
    types_hash_max_size 2048;
    server_tokens off;           # 安全基线：在错误页面和响应头中隐藏Nginx版本号。

    # 引入MIME类型定义。
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # --- 统一的、包含丰富调试信息的日志格式 ---
    log_format main_ext '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_cf_ray" '
                        'rt=$request_time uct="$upstream_connect_time" uht="$upstream_header_time" urt="$upstream_response_time"';

    # 默认的访问和错误日志路径。站点配置中可以覆盖。
    access_log /var/log/nginx/access.log main_ext;
    error_log /var/log/nginx/error.log;

    # --- Gzip 压缩配置 ---
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # --- 全局SSL/TLS安全基线 ---
    ssl_protocols TLSv1.2 TLSv1.3; # 强制使用现代、安全的TLS协议。
    ssl_prefer_server_ciphers on;  # 由服务器端协商最优的加密套件，防止降级攻击。
    ssl_session_cache shared:SSL:10m; # 开启SSL会话缓存，加速后续TLS握手。
    ssl_session_timeout 10m;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';

    # --- 全局 WebSocket Connection 头智能映射 ---
    # 这是实现优雅WebSocket代理的关键。
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # --- 导入所有站点配置 ---
    include /etc/nginx/conf.d/*.conf;
}
