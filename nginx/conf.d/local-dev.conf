# =======================================================
# 项目 "Ank" 的变量定义
#  onboarding一个新项目时，你只需要复制并修改此文件
# =======================================================

# 使用 map 指令，这是定义变量的最安全、最高效的方式
# 它只在变量被实际使用时才进行计算

# --- 项目核心变量 ---
map $host $project_ank_frontend_port {
    default "5173"; # 你的前端开发服务器端口
}
map $host $project_ank_backend_port {
    default "3000"; # 你的后端开发服务器端口
}

# --- 线上环境域名 ---
map $host $project_ank_online_domain {
    default "work.online-domain.com"; # 你的线上域名
}


# =======================================================
# 项目 "Ank" 的核心本地开发代理规则
# =======================================================

# --- 场景 A.1: 本地前端 (ank.local) ---
server {
    listen 80;
    server_name ank.local;
    # --- SSL/TLS for Local Dev (Merged from ssl_local_dev.conf) ---
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    ssl_certificate /etc/nginx/ssl/local/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/local/key.pem;

    location / {
        proxy_pass http://127.0.0.1:$project_ank_frontend_port;
        include snippets/proxy_common.conf;
        include snippets/proxy_websocket.conf; # 用于 HMR
    }
}

# --- 场景 A.2: 本地后端 (api.ank.local) ---
server {
    listen 80;
    server_name api.ank.local;
    # --- SSL/TLS for Local Dev (Merged from ssl_local_dev.conf) ---
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    ssl_certificate /etc/nginx/ssl/local/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/local/key.pem;

    location / {
        proxy_pass http://127.0.0.1:$project_ank_backend_port;
        include snippets/proxy_common.conf;
        include snippets/proxy_websocket.conf;
    }
}


# =======================================================
# 场景 B: 使用线上API进行前端开发
# 要激活此场景，确保文件名以 .conf 结尾
# =======================================================
server {
    listen 80;
    server_name $project_ank_online_domain; # 从变量文件中读取线上域名
    # --- SSL/TLS for Local Dev (Merged from ssl_local_dev.conf) ---
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    ssl_certificate /etc/nginx/ssl/local/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/local/key.pem;

    # 所有流量都导向本地前端开发服务器
    location / {
        proxy_pass http://127.0.0.1:$project_ank_frontend_port;
        include snippets/proxy_common.conf;
        include snippets/proxy_websocket.conf;
    }
}


# =======================================================
# 场景 C: 拦截线上流量到本地API进行调试
# 要激活此场景，请将文件名从 .conf.disabled 改为 .conf
# 并确保场景B的文件被禁用(例如改为 .conf.disabled)
# =======================================================
server {
    listen 80;
    server_name $project_ank_online_domain;
    # --- SSL/TLS for Local Dev (Merged from ssl_local_dev.conf) ---
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    ssl_certificate /etc/nginx/ssl/local/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/local/key.pem;

    # 规则1: 拦截API流量到本地
    location /api/ {
        proxy_pass http://127.0.0.1:$project_ank_backend_port;
        include snippets/proxy_common.conf;
        include snippets/proxy_websocket.conf;
    }

    # 规则2: 其他所有流量代理回线上真实服务器
    location / {
        proxy_pass https://$project_ank_online_domain;
        include snippets/proxy_common.conf;
        # 必须手动重写Host头，以匹配上游服务器
        proxy_set_header Host $project_ank_online_domain;
    }
}